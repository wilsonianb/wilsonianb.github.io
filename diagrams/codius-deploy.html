<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
  <div class="mermaid">
sequenceDiagram
    participant Browser
    participant Site as codius-host.com
    participant Ingress
    participant Dashboard as Kubernetes<br/>Dashboard
    participant k8s as Kubernetes
    participant k8sAuth as Webhook Token<br/>Auth Server
    participant SPSP as Host SPSP
    participant Wallet as Host's Wallet

    activate Browser
    Browser->>+Ingress: GET codius-host.com
    Ingress-->>-Browser: codius-host.com page w/ meta tag
    opt web monetization
      Browser->>+SPSP: SPSP query
      SPSP->>+Wallet: SPSP query w/ secret & nonce
      Wallet-->>-Browser: destinationAddress & sharedSecret
      deactivate SPSP
      loop ILP packet
        Browser->>+Wallet: $
        Wallet-->>-Browser: receipt
        Browser-x+Site: monetizationprogress receipt
        Site-x+k8sAuth: POST monetizationId, receipt
        k8sAuth->>k8sAuth: credits monetizationId balance
        deactivate k8sAuth
      end
      Site->>-Site: iframe src=dashboard.codius-host.com/monetizationId={id}
      Browser->>+Ingress: GET dashboard.codius-host.com/monetizationId={id}
      Ingress-->>-Browser: Kubernetes dashboard ui w/ monetizationId header
      Browser->>+Dashboard: deploy service
      Dashboard->>+k8s: POST /api/v1/namespaces/c8s-untrusted/codiusdeployments<br/>Authorization: Bearer monetizationId<br/>codius-deployment.yaml
      k8s->>+k8sAuth: monetizationId
      k8sAuth->>k8sAuth: checks id balance
      alt sufficient balance
        k8sAuth-->>-k8s: 200 "user":"codius-deploy"
        k8s->>k8s: create CodiusDeployment
        k8s->>k8s: crd operator creates deployment, service, ingress, etc
        k8s-->>-Dashboard: 201
        Dashboard-->>-Browser: "Success"
      end
    end
    deactivate Browser
  </div>
  <script async src="https://unpkg.com/mermaid@8.4.5/dist/mermaid.min.js"></script>
</body>
</html>