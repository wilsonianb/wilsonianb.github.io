<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
  <div class="mermaid">
sequenceDiagram
    participant Browser
    participant Ingress
    participant Site as codius-host.com
    participant Verifier as Receipt Verifier
    participant Wallet as Host's Wallet
    participant Dashboard as Kubernetes<br/>Dashboard
    participant k8s as Kubernetes
    participant k8sAuth as Webhook Token<br/>Auth Server

    activate Browser
    Browser->>+Ingress: GET codius-host.com
    Ingress-->>-Browser: codius-host.com page w/ meta tag
    opt web monetization
      Browser->>+Verifier: SPSP query
      Verifier->>+Wallet: SPSP query w/ secret & nonce
      Wallet-->>-Browser: destinationAddress & sharedSecret
      deactivate Verifier
      loop ILP packet
        Browser->>+Wallet: $
        Wallet-->>-Browser: receipt
        Browser-x+Site: monetizationprogress receipt
        Site-x+Verifier: POST /receipts/{requestId} receipt
        deactivate Site
        Verifier->>-Verifier: credits requestId balance
      end
      Browser-x+Site: monetizationstart requestId
      Site->>-Site: iframe src=dashboard.codius-host.com/auth=requestId
      Browser->>+Ingress: GET dashboard.codius-host.com/auth=requestId
      Ingress-->>-Browser: Kubernetes dashboard ui w/ requestId as Auth header
      Browser->>+Dashboard: deploy service
      Dashboard->>+k8s: POST /api/v1/namespaces/c8s-untrusted/codiusdeployments<br/>Authorization: Bearer requestId<br/>codius-deployment.yaml
      k8s->>+k8sAuth: requestId
      k8sAuth->>+Verifier: POST /receipts/{requestId}/spend
      alt sufficient balance
        Verifier-->>-k8sAuth: 200
        k8sAuth-->>-k8s: 200 "user":"codius-deploy"
        k8s->>k8s: create CodiusDeployment
        k8s->>k8s: crd operator creates deployment, service, ingress, etc
        k8s-->>-Dashboard: 201
        Dashboard-->>-Browser: "Success"
      end
    end
    deactivate Browser
  </div>
  <script async src="https://unpkg.com/mermaid@8.4.5/dist/mermaid.min.js"></script>
</body>
</html>