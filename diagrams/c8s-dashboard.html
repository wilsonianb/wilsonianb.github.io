<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
  <div class="mermaid">
  sequenceDiagram
    participant User
    participant Site as codius-host.com
    participant Ingress
    participant Auth as External<br/>Auth Server
    participant Dashboard as Kubernetes<br/>Dashboard
    participant k8s as Kubernetes
    participant k8sAuth as Webhook Token<br/>Auth Server
    participant Wallet as Host's Wallet

    User->>Site: [ navigates ]
    activate User
    activate Site
    opt web monetization
      User->>Wallet: $$$
    end
    Note right of Site: Kubernetes dashboard <br/>is loaded in iframe
    Site->>Ingress: GET /dashboard<br/>Authorization: Bearer jwt
    activate Ingress
    activate Ingress
    Ingress->>Auth: jwt
    activate Auth
    activate Auth
    Auth->>Wallet: /spend amount
    activate Wallet
    activate Wallet
    alt 404 || balance < amount
      Wallet-->>Auth: 400?
      deactivate Wallet
      Auth-->>Ingress: 401
      deactivate Auth
      Ingress-->>Site: 401
      deactivate Ingress
      Site-->>User: "Pay me"
    else
      Wallet-->>Auth: 200
      deactivate Wallet
      Auth-->>Ingress: 200
      deactivate Auth
      Ingress->>Dashboard: request
      deactivate Ingress
      activate Dashboard
      Dashboard-->>Site: response
      Site-->>User: [ displays iframe ]
    end
    User->>Dashboard: deployment details
    Note right of Site: CodiusDeployment <br/>is a k8s custom<br/>resource with same <br/>fields as codius <br/>manifest
    Dashboard->>k8s: POST /api/v1/namespaces/c8s-untrusted/codiusdeployments<br/>Authorization: Bearer jwt<br/>codius-deployment.yaml
    activate k8s
    activate k8s
    Note right of k8s: token sent in k8s<br/>"TokenReview"
    k8s->>k8sAuth: jwt
    activate k8sAuth
    activate k8sAuth
    k8sAuth->>Wallet: /spend amount
    activate Wallet
    activate Wallet
    alt 404 || balance < amount
      Wallet-->>k8sAuth: 400?
      deactivate Wallet
      k8sAuth-->>k8s: 401 "Authenticated": false
      deactivate k8sAuth
      k8s-->>Dashboard: 401
      deactivate k8s
      Dashboard-->>User: "Unauthenticated "
    else
      Wallet-->>k8sAuth: 200
      deactivate Wallet
      Note right of k8s: returned user is <br/>Authorized to create <br/>CodiusDeployments
      k8sAuth-->>k8s: 200 "user":"codius-deploy"
      deactivate k8sAuth
      k8s->>k8s: create CodiusDeployment
      k8s->>k8s: crd operator creates deployment, service, ingress, etc
      k8s-->>Dashboard: 301
      deactivate k8s
      Dashboard-->>User: "Success"
    end
    deactivate Site
    deactivate Dashboard
    deactivate User
  </div>
  <script async src="https://unpkg.com/mermaid@8.4.5/dist/mermaid.min.js"></script>
</body>
</html>