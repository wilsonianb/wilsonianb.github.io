<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
  <div class="mermaid">
sequenceDiagram
  participant Browser
  participant Ingress as ingress-nginx
  participant Router as edge-router
  participant Auth as edge-auth
  participant Verifier as receipt-verifier
  participant Wallet as Host's Wallet
  participant Function as Function (page)
  participant FWallet as Function's Wallet

  activate Browser
  Browser->>+Ingress: GET user.host/func
  activate Ingress
  Ingress->>+Router: GET /
  activate Router
  Router->>+Auth: GET /q/?r=/function/user-func
  activate Auth
  Auth->>+Verifier: POST /balances/{user}:spend requestPrice
  Verifier-->>-Auth: 200
  Auth-->>-Router: 200
  Router->>+Function: GET /
  Function-->>-Browser: response w/ monetization tag
  deactivate Router
  deactivate Ingress
  Browser->>+Verifier: SPSP query
  activate Verifier
  alt insufficient function balance
    Verifier->>+Wallet: SPSP query w/ secret & nonce
    Wallet-->>-Browser: destinationAddress & sharedSecret
    deactivate Verifier
    loop ILP packet
      Browser->>+Wallet: $ $ $
      Wallet-->>-Browser: receipt
      Browser-x+Function: monetizationprogress receipt
      Function->>+Verifier: POST /balances/{user}:creditReceipt receipt
      Verifier-->>-Function: 200 user balance
      deactivate Function
    end
  else sufficient balance
    Verifier->>+FWallet: SPSP query w/ secret & nonce
    FWallet-->>-Browser: destinationAddress & sharedSecret
    deactivate Verifier
    loop ILP packet
      Browser->>+FWallet: $ $ $
      FWallet-->>-Browser: receipt
      Browser-x+Function: monetizationprogress receipt
      Function->>+Verifier: POST /balances/{user}:creditReceipt receipt
      Verifier-->>-Function: 200 user balance
      deactivate Function
    end
  end
  deactivate Browser
  </div>
  <script async src="https://unpkg.com/mermaid@8.7.0/dist/mermaid.min.js"></script>
</body>
</html>
