<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
  <div class="mermaid">
sequenceDiagram
  participant Browser
  participant Page as Web page
  participant Verifier as receipt-verifier
  participant Billing as billing
  participant gateway
  participant prometheus
  participant Wallet

  activate Browser
  Browser->>+Verifier: GET pay.host/user-func Accept: application/spsp4+json
  Verifier->>+Billing: GET /paymentPointers/{user-func}
  activate Billing
  Billing->>+prometheus: GET sum(gateway_function_invocation_total{function_name="user-func"})
  prometheus-->>-Billing: 200 gateway_function_invocation_total
  Billing->>+prometheus: GET sum(gateway_function_payment_total{function_name="user-func", payment_pointer="$wallet/host"})
  prometheus-->>-Billing: 200 gateway_function_payment_total
  alt insufficient function balance
    Billing-->>-Verifier: 200 $wallet/host, webhook: /functions/user-func/receipts/paymentPointers/%24wallet%2Fhost:credit"
  else sufficient balance
    Billing->>+gateway: GET /system/function/user-func
    gateway-->>-Billing: 200 function w/ interledger.org/payment-pointer annotation
    Billing-->>-Verifier: 200 $wallet/user, webhook: /functions/user-func/receipts/paymentPointers/%24wallet%2Fuser:credit"
  end
  Verifier->>+Wallet: SPSP query w/ secret & nonce
  Wallet-->>-Browser: destinationAddress & sharedSecret
  deactivate Verifier
  loop ILP packet
    Browser->>+Wallet: $ $ $
    Wallet-->>-Browser: receipt
    Browser-x+Page: monetizationprogress receipt
    Page->>+Verifier: POST pay.host/receipts receipt
    activate Verifier
    alt valid receipt
      Verifier-x+Billing: POST webhook receiptValue
      Billing-x+prometheus: add gateway_function_payment_total{function_name="user-func", payment_pointer=:paymentPointer}) receiptValue
      deactivate prometheus
      deactivate Billing
      Verifier-->>-Page: 201 decoded receipt
    else invalid receipt
      Verifier-->>-Page: 4XX
    end
    deactivate Page
  end
  deactivate Browser
  </div>
  <script async src="https://unpkg.com/mermaid@8.7.0/dist/mermaid.min.js"></script>
</body>
</html>
