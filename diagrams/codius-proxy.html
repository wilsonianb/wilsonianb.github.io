<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
</head>
<body>
  <div class="mermaid">
sequenceDiagram
  participant Browser
  participant Ingress
  participant Auth as External<br/>Auth Server
  participant Verifier as Receipt Verifier
  participant Site as pay.host
  participant Wallet as Host's Wallet
  participant Deployment as Codius Deployment

  activate Browser
  Browser->>+Ingress: GET hash.host
  activate Ingress
  Ingress->>+Auth: request
  activate Auth
  Auth->>+Verifier: POST /receipts/{hash}/spend
  activate Verifier
  alt sufficient balance
    Verifier-->>-Auth: 200
    Auth-->>-Ingress: 200
    Ingress->>+Deployment: request
    deactivate Ingress
    Deployment-->>-Browser: response
  else insufficient balance
    Verifier-->>-Auth: 400
    Auth-->>-Browser: 402 pay.host/request=hash.host page w/ meta tag
    deactivate Ingress
    opt web monetization
      Browser->>+Site: parse monetization meta tag
      Site-->>-Browser: $host/{hash} payment pointer
      Browser->>+Verifier: SPSP query
      Verifier->>+Wallet: SPSP query w/ secret & nonce=hash
      Wallet-->>-Browser: destinationAddress & sharedSecret
      deactivate Verifier
      loop ILP packet
        Browser->>+Wallet: $
        Wallet-->>-Browser: receipt
        Browser-x+Site: monetizationprogress receipt
        Site->>+Verifier: POST /receipts receipt
        Verifier->>Verifier: credits hash balance
        Verifier-->>-Site: 200 hash balance
        alt sufficient balance
          Site->>-Site: iframe src=hash.host
        end
      end
    end
  end
  deactivate Browser
  </div>
  <script async src="https://unpkg.com/mermaid@8.4.5/dist/mermaid.min.js"></script>
</body>
</html>